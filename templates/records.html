<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑–∞–Ω–∏–π</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .pagination {
            margin: 2rem 0;
            text-align: center;
        }
        .pagination-info {
            margin: 1rem 0;
            color: #666;
            font-size: 0.9em;
        }
        .load-more-btn {
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }
        .anomaly-tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .anomaly-tooltip .tooltip-content {
            visibility: hidden;
            background-color: #fff;
            color: #333;
            border: 2px solid #e74c3c;
            border-radius: 6px;
            padding: 15px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            min-width: 250px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-size: 14px;
        }

        .anomaly-tooltip:hover .tooltip-content {
            visibility: visible;
        }

        .tooltip-header {
            color: #e74c3c;
            font-weight: bold;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .tooltip-row {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }

        .tooltip-label {
            color: #666;
            margin-right: 10px;
        }

        .no-records {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 18px;
        }

        .filter-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .reset-filters {
            background-color: #95a5a6 !important;
            margin-left: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="btn-home">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <h1>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑–∞–Ω–∏–π</h1>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filter-group">
            <div class="search-box">
                <input type="text" id="searchInput"
                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É —Å—á–µ—Ç–∞..."
                       value="{{ current_filters.account_number }}">
                <button onclick="updateFilters()" class="btn-action btn-blue">üîç –ü–æ–∏—Å–∫</button>
            </div>

            <select id="yearFilter" class="filter-select">
                <option value="">–í—Å–µ –≥–æ–¥—ã</option>
                {% for year in years %}
                <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>

            <select id="monthFilter" class="filter-select">
                <option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>
                {% for num, name in months %}
                <option value="{{ num }}" {% if num == selected_month %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
            </select>

            <div class="anomaly-filter">
                <label class="checkbox-label">
                    <input type="checkbox"
                           id="anomaliesFilter"
                           {% if current_filters.anomalies_only %}checked{% endif %}
                           onchange="updateFilters()">
                    –¢–æ–ª—å–∫–æ –∞–Ω–æ–º–∞–ª–∏–∏ ‚ö†Ô∏è
                </label>
            </div>

            <button onclick="clearFilters()" class="btn-action reset-filters">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
        <div class="pagination-info">
            –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page }} ‚Ä¢ –ó–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ: {{ records|length }}
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ -->
        {% if records %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–õ–∏—Ü–µ–≤–æ–π —Å—á–µ—Ç</th>
                        <th>–ü–æ–∫–∞–∑–∞–Ω–∏—è</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in records %}
                    <tr class="{% if record.is_anomaly %}anomaly{% endif %}">
                        <td>{{ record.timestamp.strftime('%d.%m.%Y %H:%M') }}</td>
                        <td>{{ record.account_number }}</td>
                        <td>{{ record.scale1_value }}</td>
                        <td>
                            {% if record.is_anomaly %}
                            <div class="anomaly-tooltip">
                                ‚ö†Ô∏è
                                <div class="tooltip-content">
                                    <div class="tooltip-header">–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∞–Ω–æ–º–∞–ª–∏—è</div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">–û–∂–∏–¥–∞–µ–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω:</span>
                                        <span>{{ record.expected_range }}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</span>
                                        <span>{{ record.scale1_value }}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ:</span>
                                        <span>{{ "%.2f"|format(record.deviation_score * 100) }}%</span>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <span class="status-ok">‚úì</span>
                            {% endif %}
                        </td>
                        <td>
                            <button onclick="deleteRecord('{{ record.id }}')"
                                    class="btn-action btn-red">–£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="no-records">
            –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º
        </div>
        {% endif %}

        {% if has_next %}
        <div class="pagination">
            <a href="?page={{ page + 1 }}&account_number={{ current_filters.account_number }}&year={{ current_filters.year }}&month={{ current_filters.month }}"
               class="btn-action load-more-btn">
                –ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë 100 –∑–∞–ø–∏—Å–µ–π
            </a>
        </div>
        {% endif %}
    </div>

    <script>

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        function buildUrl(page) {
            const params = new URLSearchParams();

            // –§–∏–ª—å—Ç—Ä—ã
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            const search = document.getElementById('searchInput').value.trim();

            if (year) params.set('year', year);
            if (month) params.set('month', month);
            if (search) params.set('account_number', search);

            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            params.set('page', page || 1);

            return '/records?' + params.toString();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function updateFilters() {
            const params = new URLSearchParams();
            const accountNumber = document.getElementById('searchInput').value.trim();
            const filters = {
                account_number: document.getElementById('searchInput').value.trim(),
                year: document.getElementById('yearFilter').value,
                month: document.getElementById('monthFilter').value,
                anomalies_only: document.getElementById('anomaliesFilter').checked,
                page: 1
            };

            if (document.getElementById('anomaliesFilter').checked) {
                params.set('anomalies_only', 'true');
            }

            for (const [key, value] of Object.entries(filters)) {
                if (value) params.set(key, value);
            }

            window.location.search = params.toString();
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('yearFilter').selectedIndex = 0;
            document.getElementById('monthFilter').selectedIndex = 0;
            document.getElementById('anomaliesFilter').checked = false;
            updateFilters();
        }

        // –®–∞–±–ª–æ–Ω–∏–∑–∞—Ç–æ—Ä –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë"
        function build_next_page_url() {
            const currentParams = new URLSearchParams(window.location.search);
            const currentPage = parseInt({{ page }}) || 1;
            currentParams.set('page', currentPage + 1);
            return '/records?' + currentParams.toString();
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        function updateFilters() {
            const params = new URLSearchParams();

            const accountNumber = document.getElementById('searchInput').value.trim();
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            const anomaliesOnly = document.getElementById('anomaliesFilter').checked;

            if (accountNumber) params.set('account_number', accountNumber);
            if (year) params.set('year', year);
            if (month) params.set('month', month);
            if (anomaliesOnly) params.set('anomalies_only', 'true');
            params.set('page', 1);

            window.location.search = params.toString();
        }

        function clearFilters() {
            document.getElementById('yearFilter').value = '';
            document.getElementById('monthFilter').value = '';
            document.getElementById('searchInput').value = '';
            updateFilters();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('yearFilter').addEventListener('change', updateFilters);
        document.getElementById('monthFilter').addEventListener('change', updateFilters);
        document.getElementById('anomaliesFilter').addEventListener('change', updateFilters);

        document.getElementById('searchInput').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') updateFilters();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–æ–∏—Å–∫–∞
        document.querySelector('.btn-blue').addEventListener('click', updateFilters);

        // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
        async function deleteRecord(recordId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;

            try {
                const response = await fetch(`/delete/${recordId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    document.querySelector(`tr[data-id="${recordId}"]`).remove();
                    showToast('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.detail || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                }
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        }

        // –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search)
            document.getElementById('searchInput').value = params.get('account_number') || ''
            document.getElementById('yearFilter').value = params.get('year') || ''
            document.getElementById('monthFilter').value = params.get('month') || ''
        })
    </script>
</body>
</html>